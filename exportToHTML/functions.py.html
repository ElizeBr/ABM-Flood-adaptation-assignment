<html>
<head>
<title>functions.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #2aacb8;}
.s6 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
functions.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s2">&quot;&quot;&quot; 
@author: thoridwagenblast 
 
Functions that are used in the model_file.py and agent.py for the running of the Flood Adaptation Model. 
Functions get called by the Model and Agent class. 
&quot;&quot;&quot;</span>
<span class="s3">import </span><span class="s1">random</span>
<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">math</span>
<span class="s3">from </span><span class="s1">shapely </span><span class="s3">import </span><span class="s1">contains_xy</span>
<span class="s3">from </span><span class="s1">shapely </span><span class="s3">import </span><span class="s1">prepare</span>
<span class="s3">import </span><span class="s1">geopandas </span><span class="s3">as </span><span class="s1">gpd</span>


<span class="s3">def </span><span class="s1">set_initial_values</span><span class="s4">(</span><span class="s1">input_data</span><span class="s4">, </span><span class="s1">parameter</span><span class="s4">, </span><span class="s1">seed</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Function to set the values based on the distribution shown in the input data for each parameter. 
    The input data contains which percentage of households has a certain initial value. 
     
    Parameters 
    ---------- 
    input_data: the dataframe containing the distribution of parameters 
    parameter: parameter name that is to be set 
    seed: agent's seed 
     
    Returns 
    ------- 
    parameter_set: the value that is set for a certain agent for the specified parameter  
    &quot;&quot;&quot;</span>
    <span class="s1">parameter_set </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s1">parameter_data </span><span class="s4">= </span><span class="s1">input_data</span><span class="s4">.</span><span class="s1">loc</span><span class="s4">[(</span><span class="s1">input_data</span><span class="s4">.</span><span class="s1">parameter </span><span class="s4">== </span><span class="s1">parameter</span><span class="s4">)] </span><span class="s0"># get the distribution of values for the specified parameter</span>
    <span class="s1">parameter_data </span><span class="s4">= </span><span class="s1">parameter_data</span><span class="s4">.</span><span class="s1">reset_index</span><span class="s4">()</span>
    <span class="s1">random</span><span class="s4">.</span><span class="s1">seed</span><span class="s4">(</span><span class="s1">seed</span><span class="s4">)</span>
    <span class="s1">random_parameter </span><span class="s4">= </span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s5">0</span><span class="s4">,</span><span class="s5">100</span><span class="s4">) </span>
    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range</span><span class="s4">(</span><span class="s1">len</span><span class="s4">(</span><span class="s1">parameter_data</span><span class="s4">)):</span>
        <span class="s3">if </span><span class="s1">i </span><span class="s4">== </span><span class="s5">0</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">random_parameter </span><span class="s4">&lt; </span><span class="s1">parameter_data</span><span class="s4">[</span><span class="s6">'value_for_input'</span><span class="s4">][</span><span class="s1">i</span><span class="s4">]:</span>
                <span class="s1">parameter_set </span><span class="s4">= </span><span class="s1">parameter_data</span><span class="s4">[</span><span class="s6">'value'</span><span class="s4">][</span><span class="s1">i</span><span class="s4">]</span>
                <span class="s3">break</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s4">(</span><span class="s1">random_parameter </span><span class="s4">&gt;= </span><span class="s1">parameter_data</span><span class="s4">[</span><span class="s6">'value_for_input'</span><span class="s4">][</span><span class="s1">i</span><span class="s4">-</span><span class="s5">1</span><span class="s4">]) </span><span class="s3">and </span><span class="s4">(</span><span class="s1">random_parameter </span><span class="s4">&lt;= </span><span class="s1">parameter_data</span><span class="s4">[</span><span class="s6">'value_for_input'</span><span class="s4">][</span><span class="s1">i</span><span class="s4">]):</span>
                <span class="s1">parameter_set </span><span class="s4">= </span><span class="s1">parameter_data</span><span class="s4">[</span><span class="s6">'value'</span><span class="s4">][</span><span class="s1">i</span><span class="s4">]</span>
                <span class="s3">break</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">continue</span>
    <span class="s3">return </span><span class="s1">parameter_set</span>


<span class="s3">def </span><span class="s1">get_flood_map_data</span><span class="s4">(</span><span class="s1">flood_map</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    Getting the flood map characteristics. 
     
    Parameters 
    ---------- 
    flood_map: flood map in tif format 
 
    Returns 
    ------- 
    band, bound_l, bound_r, bound_t, bound_b: characteristics of the tif-file 
    &quot;&quot;&quot;</span>
    <span class="s1">band </span><span class="s4">= </span><span class="s1">flood_map</span><span class="s4">.</span><span class="s1">read</span><span class="s4">(</span><span class="s5">1</span><span class="s4">)</span>
    <span class="s1">bound_l </span><span class="s4">= </span><span class="s1">flood_map</span><span class="s4">.</span><span class="s1">bounds</span><span class="s4">.</span><span class="s1">left</span>
    <span class="s1">bound_r </span><span class="s4">= </span><span class="s1">flood_map</span><span class="s4">.</span><span class="s1">bounds</span><span class="s4">.</span><span class="s1">right</span>
    <span class="s1">bound_t </span><span class="s4">= </span><span class="s1">flood_map</span><span class="s4">.</span><span class="s1">bounds</span><span class="s4">.</span><span class="s1">top</span>
    <span class="s1">bound_b </span><span class="s4">= </span><span class="s1">flood_map</span><span class="s4">.</span><span class="s1">bounds</span><span class="s4">.</span><span class="s1">bottom</span>
    <span class="s3">return </span><span class="s1">band</span><span class="s4">, </span><span class="s1">bound_l</span><span class="s4">, </span><span class="s1">bound_r</span><span class="s4">, </span><span class="s1">bound_t</span><span class="s4">, </span><span class="s1">bound_b</span>

<span class="s1">shapefile_path </span><span class="s4">= </span><span class="s6">r'../input_data/model_domain/houston_model/houston_model.shp'</span>
<span class="s1">floodplain_path </span><span class="s4">= </span><span class="s6">r'../input_data/floodplain/floodplain_area.shp'</span>

<span class="s0"># Model area setup</span>
<span class="s1">map_domain_gdf </span><span class="s4">= </span><span class="s1">gpd</span><span class="s4">.</span><span class="s1">GeoDataFrame</span><span class="s4">.</span><span class="s1">from_file</span><span class="s4">(</span><span class="s1">shapefile_path</span><span class="s4">)</span>
<span class="s1">map_domain_gdf </span><span class="s4">= </span><span class="s1">map_domain_gdf</span><span class="s4">.</span><span class="s1">to_crs</span><span class="s4">(</span><span class="s1">epsg</span><span class="s4">=</span><span class="s5">26915</span><span class="s4">)</span>
<span class="s1">map_domain_geoseries </span><span class="s4">= </span><span class="s1">map_domain_gdf</span><span class="s4">[</span><span class="s6">'geometry'</span><span class="s4">]</span>
<span class="s1">map_minx</span><span class="s4">, </span><span class="s1">map_miny</span><span class="s4">, </span><span class="s1">map_maxx</span><span class="s4">, </span><span class="s1">map_maxy </span><span class="s4">= </span><span class="s1">map_domain_geoseries</span><span class="s4">.</span><span class="s1">total_bounds</span>
<span class="s1">map_domain_polygon </span><span class="s4">= </span><span class="s1">map_domain_geoseries</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]  </span><span class="s0"># The geoseries contains only one polygon</span>
<span class="s1">prepare</span><span class="s4">(</span><span class="s1">map_domain_polygon</span><span class="s4">)</span>

<span class="s0"># Floodplain setup</span>
<span class="s1">floodplain_gdf </span><span class="s4">= </span><span class="s1">gpd</span><span class="s4">.</span><span class="s1">GeoDataFrame</span><span class="s4">.</span><span class="s1">from_file</span><span class="s4">(</span><span class="s1">floodplain_path</span><span class="s4">)</span>
<span class="s1">floodplain_gdf </span><span class="s4">= </span><span class="s1">floodplain_gdf</span><span class="s4">.</span><span class="s1">to_crs</span><span class="s4">(</span><span class="s1">epsg</span><span class="s4">=</span><span class="s5">26915</span><span class="s4">)</span>
<span class="s1">floodplain_geoseries </span><span class="s4">= </span><span class="s1">floodplain_gdf</span><span class="s4">[</span><span class="s6">'geometry'</span><span class="s4">]</span>
<span class="s1">floodplain_multipolygon </span><span class="s4">= </span><span class="s1">floodplain_geoseries</span><span class="s4">[</span><span class="s5">0</span><span class="s4">]  </span><span class="s0"># The geoseries contains only one multipolygon</span>
<span class="s1">prepare</span><span class="s4">(</span><span class="s1">floodplain_multipolygon</span><span class="s4">)</span>


<span class="s3">def </span><span class="s1">generate_random_location_within_map_domain</span><span class="s4">():</span>
    <span class="s2">&quot;&quot;&quot; 
    Generate random location coordinates within the map domain polygon. 
 
    Returns 
    ------- 
    x, y: lists of location coordinates, longitude and latitude 
    &quot;&quot;&quot;</span>
    <span class="s3">while True</span><span class="s4">:</span>
        <span class="s0"># generate random location coordinates within square area of map domain</span>
        <span class="s1">x </span><span class="s4">= </span><span class="s1">random</span><span class="s4">.</span><span class="s1">uniform</span><span class="s4">(</span><span class="s1">map_minx</span><span class="s4">, </span><span class="s1">map_maxx</span><span class="s4">)</span>
        <span class="s1">y </span><span class="s4">= </span><span class="s1">random</span><span class="s4">.</span><span class="s1">uniform</span><span class="s4">(</span><span class="s1">map_miny</span><span class="s4">, </span><span class="s1">map_maxy</span><span class="s4">)</span>
        <span class="s0"># check if the point is within the polygon, if so, return the coordinates</span>
        <span class="s3">if </span><span class="s1">contains_xy</span><span class="s4">(</span><span class="s1">map_domain_polygon</span><span class="s4">, </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">):</span>
            <span class="s3">return </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y</span>

<span class="s3">def </span><span class="s1">get_flood_depth</span><span class="s4">(</span><span class="s1">corresponding_map</span><span class="s4">, </span><span class="s1">location</span><span class="s4">, </span><span class="s1">band</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;  
    To get the flood depth of a specific location within the model domain. 
    Households are placed randomly on the map, so the distribution does not follow reality. 
     
    Parameters 
    ---------- 
    corresponding_map: flood map used 
    location: household location (a Shapely Point) on the map 
    band: band from the flood map 
 
    Returns 
    ------- 
    depth: flood depth at the given location 
    &quot;&quot;&quot;</span>
    <span class="s1">row</span><span class="s4">, </span><span class="s1">col </span><span class="s4">= </span><span class="s1">corresponding_map</span><span class="s4">.</span><span class="s1">index</span><span class="s4">(</span><span class="s1">location</span><span class="s4">.</span><span class="s1">x</span><span class="s4">, </span><span class="s1">location</span><span class="s4">.</span><span class="s1">y</span><span class="s4">)</span>
    <span class="s1">depth </span><span class="s4">= </span><span class="s1">band</span><span class="s4">[</span><span class="s1">row </span><span class="s4">-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">col </span><span class="s4">-</span><span class="s5">1</span><span class="s4">]</span>
    <span class="s3">return </span><span class="s1">depth</span>
    

<span class="s3">def </span><span class="s1">get_position_flood</span><span class="s4">(</span><span class="s1">bound_l</span><span class="s4">, </span><span class="s1">bound_r</span><span class="s4">, </span><span class="s1">bound_t</span><span class="s4">, </span><span class="s1">bound_b</span><span class="s4">, </span><span class="s1">img</span><span class="s4">, </span><span class="s1">seed</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;  
    To generate the position on flood map for a household. 
    Households are placed randomly on the map, so the distribution does not follow reality. 
     
    Parameters 
    ---------- 
    bound_l, bound_r, bound_t, bound_b, img: characteristics of the flood map data (.tif file) 
    seed: seed to generate the location on the map 
 
    Returns 
    ------- 
    x, y: location on the map 
    row, col: location within the tif-file 
    &quot;&quot;&quot;</span>
    <span class="s1">random</span><span class="s4">.</span><span class="s1">seed</span><span class="s4">(</span><span class="s1">seed</span><span class="s4">)</span>
    <span class="s1">x </span><span class="s4">= </span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s1">round</span><span class="s4">(</span><span class="s1">bound_l</span><span class="s4">, </span><span class="s5">0</span><span class="s4">), </span><span class="s1">round</span><span class="s4">(</span><span class="s1">bound_r</span><span class="s4">, </span><span class="s5">0</span><span class="s4">))</span>
    <span class="s1">y </span><span class="s4">= </span><span class="s1">random</span><span class="s4">.</span><span class="s1">randint</span><span class="s4">(</span><span class="s1">round</span><span class="s4">(</span><span class="s1">bound_b</span><span class="s4">, </span><span class="s5">0</span><span class="s4">), </span><span class="s1">round</span><span class="s4">(</span><span class="s1">bound_t</span><span class="s4">, </span><span class="s5">0</span><span class="s4">))</span>
    <span class="s1">row</span><span class="s4">, </span><span class="s1">col </span><span class="s4">= </span><span class="s1">img</span><span class="s4">.</span><span class="s1">index</span><span class="s4">(</span><span class="s1">x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">)</span>
    <span class="s3">return </span><span class="s1">x</span><span class="s4">, </span><span class="s1">y</span><span class="s4">, </span><span class="s1">row</span><span class="s4">, </span><span class="s1">col</span>

<span class="s3">def </span><span class="s1">calculate_basic_flood_damage</span><span class="s4">(</span><span class="s1">flood_depth</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot; 
    To get flood damage based on flood depth of household 
    from de Moer, Huizinga (2017) with logarithmic regression over it. 
    If flood depth &gt; 6m, damage = 1. 
     
    Parameters 
    ---------- 
    flood_depth : flood depth as given by location within model domain 
 
    Returns 
    ------- 
    flood_damage : damage factor between 0 and 1 
    &quot;&quot;&quot;</span>
    <span class="s3">if </span><span class="s1">flood_depth </span><span class="s4">&gt;= </span><span class="s5">6</span><span class="s4">:</span>
        <span class="s1">flood_damage </span><span class="s4">= </span><span class="s5">1</span>
    <span class="s3">elif </span><span class="s1">flood_depth </span><span class="s4">&lt; </span><span class="s5">0.025</span><span class="s4">:</span>
        <span class="s1">flood_damage </span><span class="s4">= </span><span class="s5">0</span>
    <span class="s3">else</span><span class="s4">:</span>
        <span class="s0"># see flood_damage.xlsx for function generation</span>
        <span class="s1">flood_damage </span><span class="s4">= </span><span class="s5">0.1746 </span><span class="s4">* </span><span class="s1">math</span><span class="s4">.</span><span class="s1">log</span><span class="s4">(</span><span class="s1">flood_depth</span><span class="s4">) + </span><span class="s5">0.6483</span>
        <span class="s0">#flood_damage_without_measures = 0.1746 * math.log(flood_depth) + 0.6483</span>
        <span class="s0">#flood_damage = flood_damage_without_measures*(1-self.taken_measures)</span>
    <span class="s3">return </span><span class="s1">flood_damage</span>
</pre>
</body>
</html>